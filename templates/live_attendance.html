<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live Camera Attendance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        body {
            background: #0a192f;
            font-family: 'Share Tech Mono', monospace;
            color: #e0e8ff;
            overflow-x: hidden;
        }
        .glow {
            text-shadow: 0 0 8px #38bdf8, 0 0 16px #2563eb;
        }
        .blue-line {
            width: 100vw;
            height: 2px;
            background: linear-gradient(90deg, #38bdf8 0%, #2563eb 100%);
            margin: 24px 0;
            opacity: 0.4;
            animation: moveLine 2s linear infinite;
        }
        @keyframes moveLine {
            0% { transform: translateX(-20vw);}
            100% { transform: translateX(20vw);}
        }
        #matrix-canvas {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            z-index: 0;
            pointer-events: none;
        }
        .main-content {
            position: relative;
            z-index: 1;
        }
        .scanner-wheel {
            border: 6px solid #38bdf8;
            border-top: 6px solid #2563eb;
            border-radius: 50%;
            width: 64px;
            height: 64px;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg);}
            100% { transform: rotate(360deg);}
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center">
<canvas id="matrix-canvas"></canvas>
<div class="main-content bg-[#101f3a] bg-opacity-90 rounded-xl shadow-2xl p-8 w-full max-w-lg border border-cyan-700 mt-10">
    <div class="scanner-wheel"></div>
    <div class="blue-line"></div>
    <h1 class="text-2xl font-bold text-cyan-300 glow mb-4 text-center">Live Camera Attendance</h1>
    <form id="liveAttendanceForm" class="mb-4">
        <label class="block text-lg font-medium text-cyan-200 mb-2">Qualification <span class="text-red-600">*</span></label>
        <select id="qualificationId" name="qualification_id" class="block w-full text-sm text-cyan-600 border border-cyan-300 rounded-lg shadow-sm focus:ring-cyan-500 focus:border-cyan-500 p-2 mb-4 bg-[#0a192f]" required>
            <option value="">Select Qualification</option>
            {% for q in qualifications %}
            <option value="{{ q.id }}">{{ q.name }}</option>
            {% endfor %}
        </select>
        <label class="block text-lg font-medium text-cyan-200 mb-2">Module <span class="text-red-600">*</span></label>
        <select id="moduleId" name="module_id" class="block w-full text-sm text-cyan-600 border border-cyan-300 rounded-lg shadow-sm focus:ring-cyan-500 focus:border-cyan-500 p-2 mb-4 bg-[#0a192f]" required>
            <option value="">Select Module</option>
            {% for m in modules %}
            <option value="{{ m.id }}">{{ m.name }}</option>
            {% endfor %}
        </select>
    </form>
    <video id="video" width="100%" height="320" autoplay class="rounded border mb-4"></video>
    <div class="flex justify-center mb-4">
        <button id="startBtn" class="bg-cyan-600 text-white px-4 py-2 rounded mr-2">Start Attendance</button>
        <button id="stopBtn" class="bg-red-600 text-white px-4 py-2 rounded" disabled>Stop</button>
        <button id="reviewBtn" class="bg-green-600 text-white px-4 py-2 rounded ml-2" style="display:none;">Review & Save</button>
    </div>
    <div id="status" class="text-center text-cyan-200 mb-2"></div>
    <div id="spinner" class="flex justify-center mb-2" style="display:none;">
        <svg class="animate-spin h-6 w-6 text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path></svg>
    </div>
    <div id="results" class="mt-4"></div>
</div>
<script>
    // Matrix code rain effect
    const canvas = document.getElementById('matrix-canvas');
    const ctx = canvas.getContext('2d');
    let width = window.innerWidth;
    let height = window.innerHeight;
    canvas.width = width;
    canvas.height = height;
    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    const fontSize = 18;
    const columns = Math.floor(width / fontSize);
    const drops = Array(columns).fill(1);
    function drawMatrix() {
        ctx.fillStyle = "rgba(10,25,47,0.15)";
        ctx.fillRect(0, 0, width, height);
        ctx.font = fontSize + "px 'Share Tech Mono', monospace";
        ctx.fillStyle = "#38bdf8";
        for (let i = 0; i < drops.length; i++) {
            const text = letters[Math.floor(Math.random() * letters.length)];
            ctx.fillText(text, i * fontSize, drops[i] * fontSize);
            if (drops[i] * fontSize > height && Math.random() > 0.975) {
                drops[i] = 0;
            }
            drops[i]++;
        }
    }
    setInterval(drawMatrix, 50);
    window.addEventListener('resize', () => {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
    });

    // Camera logic (unchanged)
    const video = document.getElementById('video');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusDiv = document.getElementById('status');
    const resultsDiv = document.getElementById('results');
    const qualificationId = document.getElementById('qualificationId');
    const moduleId = document.getElementById('moduleId');
    let stream = null;
    let intervalId = null;
    let lastResults = null;

    async function startCamera() {
        stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
    }

    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            video.srcObject = null;
        }
    }

    function captureFrame() {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        return canvas.toDataURL('image/jpeg');
    }

    async function sendFrame() {
        const imageData = captureFrame();
        if (!qualificationId.value || !moduleId.value) {
            statusDiv.textContent = 'Qualification and module are required.';
            return;
        }
        statusDiv.textContent = 'Processing...';
        document.getElementById('spinner').style.display = 'flex';
        try {
            const response = await fetch('/live-attendance', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    camera_image: imageData,
                    qualification_id: qualificationId.value,
                    module_id: moduleId.value
                })
            });
            if (response.ok) {
                const html = await response.text();
                lastResults = html;
                document.getElementById('reviewBtn').style.display = 'inline-block';
                resultsDiv.innerHTML = '<div class="text-green-700">Scan complete. Click "Review & Save" to view and save results.</div>';
            } else {
                resultsDiv.innerHTML = `<div class='text-red-600'>Error: ${response.statusText}</div>`;
            }
        } catch (err) {
            resultsDiv.innerHTML = `<div class='text-red-600'>Error: ${err}</div>`;
        }
        statusDiv.textContent = '';
        document.getElementById('spinner').style.display = 'none';
    }

    startBtn.onclick = async () => {
        if (!qualificationId.value || !moduleId.value) {
            statusDiv.textContent = 'Qualification and module are required.';
            return;
        }
        await startCamera();
        startBtn.disabled = true;
        stopBtn.disabled = false;
        statusDiv.textContent = 'Camera started. Scanning for faces...';
        intervalId = setInterval(sendFrame, 5000); // Scan every 5 seconds
    };

    stopBtn.onclick = () => {
        stopCamera();
        startBtn.disabled = false;
        stopBtn.disabled = true;
        statusDiv.textContent = 'Camera stopped.';
        clearInterval(intervalId);
    };

    document.getElementById('reviewBtn').onclick = () => {
        if (lastResults) {
            document.open();
            document.write(lastResults);
            document.close();
        }
    };
</script>
</body>
</html>